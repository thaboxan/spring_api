name: Deploy to VM (Self-Hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-to-vm:
    name: Deploy to VM
    runs-on: self-hosted  # Uses self-hosted runner on your VM
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build JAR
        run: ./mvnw clean package -DskipTests
      
      - name: Stop existing application
        run: |
          if [ -f $HOME/spring-api/app.pid ]; then
            kill $(cat $HOME/spring-api/app.pid) || true
            rm $HOME/spring-api/app.pid
          fi
        continue-on-error: true
      
      - name: Create deployment directory
        run: mkdir -p $HOME/spring-api
      
      - name: Copy JAR to deployment directory
        run: |
          cp target/*.jar $HOME/spring-api/
          cp src/main/resources/application*.properties $HOME/spring-api/
      
      - name: Start application
        run: |
          cd $HOME/spring-api
          
          # Find the JAR file
          JAR_FILE=$(ls -t *.jar | head -n1)
          
          # Start new application
          nohup java -jar $JAR_FILE \
            --spring.config.location=file:./application.properties \
            --server.port=8081 \
            > app.log 2>&1 &
          
          echo $! > app.pid
          
          echo "Application started with PID: $(cat app.pid)"
      
      - name: Wait for application to start
        run: |
          echo "Waiting for application to be ready..."
          sleep 10
          
          if ps -p $(cat $HOME/spring-api/app.pid) > /dev/null; then
            echo "✓ Application is running"
            curl -f http://localhost:8081/ || echo "Health check endpoint tested"
          else
            echo "✗ Failed to start application"
            cat $HOME/spring-api/app.log
            exit 1
          fi
      
      - name: Show deployment info
        if: success()
        run: |
          echo "==================================="
          echo "Deployment successful!"
          echo "==================================="
          echo "Application PID: $(cat $HOME/spring-api/app.pid)"
          echo "Running on port: 8081"
          echo "Log file: $HOME/spring-api/app.log"
          echo "==================================="

  verify-deployment:
    name: Verify Deployment
    runs-on: self-hosted
    needs: deploy-to-vm
    
    steps:
      - name: Check application status
        run: |
          echo "=== Application Status ==="
          if [ -f $HOME/spring-api/app.pid ] && ps -p $(cat $HOME/spring-api/app.pid) > /dev/null; then
            echo "✓ Application process is running (PID: $(cat $HOME/spring-api/app.pid))"
          else
            echo "✗ Application process is not running"
            exit 1
          fi
      
      - name: Show recent logs
        run: |
          echo "=== Recent Application Logs ==="
          tail -n 30 $HOME/spring-api/app.log
      
      - name: Test API endpoint
        run: |
          echo "=== Testing API Endpoints ==="
          curl -f http://localhost:8081/ || echo "Root endpoint test"
          curl -f http://localhost:8081/api/todos || echo "API todos endpoint test"
